---
title: Windows 10 Azure AD joined token request  - Internet Installation wokrflow
titleSuffix: Configuration Manager
description: Learn how to AAD and CCM tokens work on Windows 10
---

# Windows 10 client AAD authentication workflow while installing

## 1. AAD Token Request

Windows 10 AADJ client uses AAD parameters to request AAD token.

1.1 Request AAD Device token:

*Getting AAD (device) token with: ClientId = f1f9b14e-55b8-4f17-8c54-2593f6eee91e, ResourceUrl = https://ConfigMgrService, AccountId = https://login.microsoftonline.com/common/oauth2/token*

1.2 If Device token is not retrieved, we request AAD user token:
*Getting AAD (user) token with: ClientId = f1f9b14e-55b8-4f17-8c54-2593f6eee91e, ResourceUrl = https://ConfigMgrService, AccountId = 649FC29A-ECE3-4A3B-A3C1-680A2F035A6E*


## 2. CCM token request:

2.1 Request CCM Token:

*Getting CCM Token from STS server 'CloudManagementGateway.cloudapp.net/CCM_PROXY_MUTUALAUTH/XXXXXX037938216'*
*Getting CCM Token from https://CloudManagementGateway.cloudapp.net/CCM_PROXY_MUTUALAUTH/XXXXXX037938216/CCM_STS*

## 3. Client request are done appending CCM token:

We cache the token and use it to request location, site information and content location through Cloud Management Gateway:

*Cached encrypted token for 'S-1-5-18'. Will expire at '00/99/2999 00:00:00'*
*Sending location request to 'CloudManagementGateway.cloudapp.net/CCM_PROXY_MUTUALAUTH/XXXXXX037938216' with payload '< Request >*
*Appending CCM Token to the header.*

Once we are able to get client content from Distribution Point

Notes:

Traffics with invalid token will be blocked upfront on CMG service, We don’t route request to internal roles

If WPJ certificate is not found, we do not try to request AAD token (client is not properly AAD joined).

AAD (device) token is available from 1806. Previously, only AAD user token can be used but we try Device as well.

If AAD token cannot be retrieved from AAD we fallback to client certificate.



2. CCM Token Request (Once we get AAD User token, we request CCM token):

2.1 CMG Gets request -- _Getting CCM Token from https://myCMG.cloudapp.net/CCM_Proxy_ServerAuth/9/CCM_STS (CCMSetup.log)

2.2 CMG moves request to CMG CP (IIS log, %CMGHttpHandler.log)

2.3 CMG CP transforms CMG client request to MP client request -- https://myMP.Mylab.com/CCM_STS (SMS_CLOUD_PROXYCONNECTOR.log)

2**.4 MP runs request against Database to verify user token** (CCM_STS.log)



### Communications Validation:

CMG validates client token (via CMG, CMG CP and HTTP(S) and MP database request).

Client verifies CMG service certificate (or management certificate)

PKI for CMG Service certificate: Client requires Root CA of the CMG certificate on local store

Third party CMG service certificate: Clients automatically validates certificate (Root CA published on internet)



## Common issues:

WPJ cert not found ( client Azure regsitered, not AAD joined)

Root CA certificate not present on Client Root CA store.

CRL check enabled (use the /NoCRLcheck option in command line or publish CRL on internet*)



*Using /NoCRLCheck is only good for ccmsetup bootstrap . For the clients to fully functional, admins need to disable CRL check on that site’s client communication page. Otherwise after security settings refreshed by location service, the clients will not talk to the server anymoreEnvironment
