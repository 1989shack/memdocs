---
author: aczechowski
ms.author: aaroncz
ms.prod: configuration-manager
ms.technology: configmgr-core
ms.topic: include
ms.date: 05/27/2021
---

## <a name="bkmk_invext"></a> New collection filter rule based on custom tags

<!--8939867-->

To support a more customizable collection-building experience, you can now create custom tags on devices or users. Then when you specify the criteria for collection membership, you can select these custom tags.

<!-- For example, ... -->

### Prerequisites for custom tags

- To set tags, you need **Modify** permission on the target device or user.
- To view tags, you need **Read** permission on the target device or user.
- To remove tags, you need **Delete** permission on the collection.

### Try it out!

Try to complete the tasks. Then send [Feedback](../../../../understand/product-feedback.md) with your thoughts on the feature.

#### Create tags

To create the tags, you use the [administration service](../../../../../develop/adminservice/index.yml). The site stores the tag's name and its value in the site database as the new **Device Extension Data** class.

The following admin service APIs examples show how you can set, view, and remove the tags. They use PowerShell to make the API calls, using sample values for the SMS Provider and device resource ID.

> [!TIP]
> The following examples use devices. The same process works for user objects too.

##### Set tags on a device

To set tags on a device, use the **SetExtensionData** API. Make a POST call to the URI `https://<SMSProviderFQDN>/AdminService/v1.0/Device(<DeviceResourceID>)/AdminService.SetExtensionData` with a JSON body that contains name-value pairs for the tag name and value.

```powershell
$uri = "https://cm01.contoso.com/AdminService/v1.0/Device(16777345)/AdminService.SetExtensionData"
$body = '{ExtensionData:{"tag1":"value1","tag2":"value2"}}'
Invoke-RestMethod -Method "Post" -Uri $uri -UseDefaultCredentials -Body $body
```

##### View tags on a single device

To view tags on a single device, use the **GetExtensionData** API for a specific device. Make a GET call to the URI `https://<SMSProviderFQDN>/AdminService/v1.0/Device(<DeviceResourceID>)/AdminService.GetExtensionData`.

```powershell
$uri = "https://cm01.contoso.com/AdminService/v1.0/Device(16777345)/AdminService.GetExtensionData"
Invoke-RestMethod -Method "Get" -Uri $uri -UseDefaultCredentials
```

##### View tags on all devices

To view tags on all devices, use the **GetExtensionData** API without a device ID. Make a GET call to the URI `https://<SMSProviderFQDN>/AdminService/v1.0/Device/AdminService.GetExtensionData`. This call returns tag values from devices to which you have read permission.

```powershell
$uri = "https://cm01.contoso.com/AdminService/v1.0/Device/AdminService.GetExtensionData"
Invoke-RestMethod -Method "Get" -Uri $uri -UseDefaultCredentials
```

##### Remove tags

To remove tag values from all devices, use the **DeleteExtensionData** API without a device ID. Include a device resource ID to only remove tags from a specific device. Make a POST call to the URI `https://<SMSProviderFQDN>/AdminService/v1.0/Device/AdminService.DeleteExtensionData`.

```powershell
$uri = "https://cm01.contoso.com/AdminService/v1.0/Device/AdminService.GetExtensionData"
Invoke-RestMethod -Method "Get" -Uri $uri -UseDefaultCredentials
```

#### Create a collection

Use the following steps to create a collection with a query rule based on the custom tags:

1. In the Configuration Manager console, [Create a collection](../../../../clients/manage/collections/create-collections.md).
1. On the Membership Rules page, in the **Add Rule** list, select **Query rule**.
1. In the Query Rule Properties window, specify a **Name** for the query. Then select **Edit Query Statement**.
1. On the **Criteria** tab of the collection query statement properties window, select the golden asterisk (`*`) to add new criteria.
1. In the Criterion Properties window, **Select** the following values:

    - Attribute class: **Device Extension Data**
    - Attribute: **PropertyName**

1. Select an **Operator** and then specify the name of the tag as the **Value**.

    At this point, the Criterion Properties window should look similar to the following image:

    <!-- screenshot -->

    Select **OK** to save the criterion.

1. Repeat the steps to add a criterion for the **PropertyValue** attribute.

    At this point, the collection Query Statement Properties window should look similar to the following image:

    <!-- screenshot -->

1. Select **OK** to close all property windows. Then complete the wizard to create the collection.

You can also use the following sample query. In the query statement properties window, select **Show Query Language** to paste the query statement.

```sql
select SMS_R_SYSTEM.ResourceID,SMS_R_SYSTEM.ResourceType,SMS_R_SYSTEM.Name,SMS_R_SYSTEM.SMSUniqueIdentifier,SMS_R_SYSTEM.ResourceDomainORWorkgroup,SMS_R_SYSTEM.Client 
from SMS_R_System inner join SMS_G_System_ExtensionData on SMS_G_System_ExtensionData.ResourceId = SMS_R_System.ResourceId 
where SMS_G_System_ExtensionData.PropertyName = "AssetTag" and SMS_G_System_ExtensionData.PropertyValue = "123456"
```
